# 项目详情

本文档包含了关于"雷霆战机"游戏机制和技术方面的更详细信息。

## 内部游戏机制

### 游戏胜利系统
- **胜利条件**: 玩家通过击败最高游戏关卡（可通过 `MAX_GAME_LEVEL` 常量配置）的最终Boss来取得胜利。
- **最终Boss战**: 最终Boss会带来更强的挑战，并提供双倍分数奖励（Boss等级 × 1000分，普通为500分）。
- **胜利处理流程**: 
  - 击败最终Boss后自动检测胜利条件。
  - 游戏状态立即切换到胜利模式。
  - 背景音乐淡出，并播放胜利音效。
  - 停止生成新的敌人和道具。
- **胜利统计**: 提供全面的通关数据，包括：
  - 包含Boss击败奖励的最终得分。
  - 以分钟为单位的总生存时间。
  - 完成的关卡数。
  - 成就通知。
- **胜利界面**: 
  - 为保持视觉连续性，保留游戏背景。
  - 采用半透明浮层和优雅的胜利面板。
  - 居中的统计数据显示，采用绿色胜利主题。
  - 闪烁的退出提示，引导用户操作。
- **重复处理防护**: 强大的系统可防止重复处理胜利逻辑和滥发通知。

### 玩家系统
- **僚机**：玩家可以拥有可配置数量的僚机（默认最多2架），通过收集 `Wing-manItem` 获得。僚机会为玩家抵挡一次攻击并自我牺牲。初始数量、最大数量和编队间距均可在 `constants.py` 文件中配置。
- **导弹**：僚机会周期性地发射追踪导弹。这些导弹会寻找最近的敌人，并在Boss激活时优先攻击Boss。

### 敌人系统
- **敌人等级**：敌人等级范围为0-10级。等级越高，生命值、速度和攻击力越强。
- **敌人生成**：随着游戏时间和游戏关卡的推进，敌人的数量和等级会增加。
- **敌人射击**：2级及以上的敌人可以射击（可通过 `ENEMY_SHOOT_LEVEL` 常量配置）。射速和子弹速度随等级提升。
  - 低等级敌人：发射简单的子弹，直线下降。
  - 中等级敌人：发射更快的子弹，可能有更复杂的移动模式。
  - 高等级敌人：发射速度更快、伤害更高的子弹。

### 子弹系统
- **玩家子弹**：根据收集的道具，最多可拥有4条射击弹道。
- **敌人子弹**：根据敌人等级，外观、速度和伤害各不相同。
- **Boss子弹**：特殊的大型子弹，伤害更高。

### 道具系统
- **生命道具（HealthItem）**：恢复玩家生命值。
- **子弹加速道具（BulletSpeedItem）**：提升玩家子弹速度。
- **弹道增加道具（BulletPathItem）**：增加玩家的射击弹道数量。
- **玩家加速道具（PlayerSpeedItem）**：提升玩家的移动速度。
- **僚机道具（WingmanItem）**：增加一架僚机与玩家并肩作战。
- **道具生成**：随着游戏进行和击败敌人获得分数，道具会随机生成。

### Boss 系统
- **Boss等级**: Boss是根据游戏进度动态生成的。其等级计算公式为 `max(1, (game_level + 1) // 2)`。这意味着随着玩家在10个游戏关卡中前进，Boss的等级也会提升。
- **Boss生成**: 从游戏第2关卡开始，每50秒生成一个Boss。在早期关卡（0-1级）不会出现Boss。
- **Boss生命系统**: 
  - 基础生命值: `100 + (level-1) * 50` 点
  - Boss上方显示生命条和等级指示器
  - 生命条根据攻击模式变化颜色
- **Boss攻击模式**: Boss具有三种不同的攻击模式，根据生命值百分比变化：
  - **普通模式** (100%-50%生命值): 标准子弹模式
    - 1级: 3颗子弹直线排列
    - 2级: 4颗子弹扇形分布
    - 3级+: 5颗子弹更宽扇形分布
  - **激进模式** (50%-25%生命值, 仅2级+): 增加子弹数量和射速
    - 射击间隔减少30%
    - 更多子弹，更宽的散布模式
    - 生命条显示黄色边框警告
  - **终极模式** (25%-0%生命值, 仅3级+): 最高强度，带玩家追踪
    - 射击间隔再减少20%
    - 最大子弹数量 (3级+最多7颗子弹)
    - 部分子弹追踪玩家位置
    - 生命条显示闪烁红色边框
- **Boss移动**: 
  - 入场动画: 从屏幕顶部滑下
  - 水平移动: 左右移动模式，动态边界
  - 移动速度随游戏关卡增加
  - 移动范围根据游戏进度调整
- **Boss子弹**: 特殊子弹系统，具有基于模式的特性：
  - **普通子弹**: 洋红色，标准速度 (5像素/帧)，10点伤害
  - **激进子弹**: 橙红色，更快速度 (6像素/帧)，15点伤害，大20%
  - **终极子弹**: 青色，最快速度 (7像素/帧)，20点伤害，大30%，玩家追踪
- **视觉效果**: 
  - 多层伤害闪现效果 (白色、红色、黄色)
  - 生命条上的攻击模式指示器
  - 多层发光子弹效果
- **Boss击败奖励**: 击败Boss提供分数奖励（普通Boss为Boss等级 × 500分，最终Boss为Boss等级 × 1000分），并触发关卡升级或游戏胜利。

### 关卡等级系统
- **早期游戏 (0-1级)**: 玩家通过分数积累来升级。这提供了一个友好的学习阶段，玩家可以在没有Boss压力的情况下熟悉游戏机制。
- **中后期游戏 (2级以上)**: 关卡升级完全依靠击败Boss。分数积累不再触发关卡升级，创造了一个基于技巧的升级系统。
- **最终关卡胜利**: 到达并击败 `MAX_GAME_LEVEL` 关卡的Boss将触发游戏完成，而不是进入下一关。
- **双重升级机制**: 
  - 基于分数的升级: 仅适用于0→1级和1→2级
  - 基于Boss击败的升级: 从2级开始可用，提供更大的奖励和挑战
  - 胜利通关: 在最高关卡击败最终Boss，触发游戏完成。
- **清晰的升级路径**: 玩家在升级时会收到清晰的视觉通知，包括清除的敌机数量和获得的奖励分数。

### 视觉效果系统
- **🎨 动态关卡背景系统**: 采用革命性的双缓冲渲染技术，实现无缝关卡过渡
  - **关卡主题**: 每个关卡都具有反映难度递增的独特视觉标识：
    - 第1关 "深空": 宁静的蓝/黑色星空（2个星云，1颗行星）
    - 第2关 "星云场": 紫/蓝色云团（4个星云，2颗行星）
    - 第3关 "小行星带": 棕/橙色小行星场，带动画碎片效果（3个星云，3颗行星）
    - 第4关 "红色禁区": 危险的红色太空，带粒子风暴效果（5个星云，2颗行星）
    - 第5关+ "最终决战": 阴森的暗红色氛围，带强烈风暴效果（6个星云，1颗行星）
  - **双缓冲技术**: 将关卡背景预渲染到独立缓冲区，实现无瑕疵过渡
  - **平滑过渡**: 3秒过渡动画，采用三次贝塞尔缓动（t³(6t² - 15t + 10)）和Alpha混合
  - **特殊效果**:
    - 太空风暴: 危险关卡的动画红色粒子，带正弦运动轨迹
    - 小行星场: 第3关的程序化生成旋转小行星
    - Alpha支持: 所有效果支持过渡期间的平滑淡入/淡出
  - **硬件优化**: 使用pygame.BLEND_ALPHA_SDL2以获得最大性能
  - **视觉优化**: 增强的关卡指示器，带发光效果和精致浮层
- **爆炸效果**: 当一个实体（敌人、僚机）被摧毁时，或当导弹击中目标时触发。
- **闪现效果**: 用于非致命伤害。实体本身会闪烁特定颜色以表明被击中。这提供了更清晰的反馈，且不会使屏幕混乱。
    - 玩家被击中: 闪烁白色。
    - Boss被子弹击中: 闪烁黄色。
    - Boss被导弹击中: 闪烁红色 (伴随导弹的爆炸效果)。
- **胜利效果**: 为游戏胜利设计的特殊视觉处理：
    - 保留背景以维持视觉连续性
    - 半透明浮层系统
    - 优雅的胜利面板和边框效果
    - 从游戏到胜利状态的平滑过渡

### 音效系统
- **背景音乐**: 在游戏过程中循环播放，在胜利时自动淡出。
- **爆炸音效**: 在敌人被摧毁时播放。
- **命中音效**: 在玩家受到伤害时播放。
- **死亡音效**: 在玩家飞船被摧毁时播放。
- **道具拾取音效**: 在收集道具时播放。
- **Boss被击败音效**: 在成功击败Boss时播放。
- **胜利音效**: 为游戏胜利设计的特殊音频反馈。
- **音量控制**: 可以独立调节音效和音乐的音量。
- **系统稳定性**: 音效系统包含一个强大的健康检查和自动恢复机制。它会周期性地检查自身状态，并在检测到问题时（例如背景音乐意外停止）自动重新初始化。这确保了在长时间游戏过程中的高可靠性。
- **音频独立性**: 修复了切换音效会错误停止背景音乐的问题。音乐和音效现在按预期独立运作。

### 日志系统
- 支持不同级别（DEBUG、INFO、WARNING、ERROR、CRITICAL）的标准化日志输出。
- 可通过 `THUNDER_FIGHTER_LOG_LEVEL` 环境变量调整日志级别（详见 `README_ZH.md` 中的 [如何运行](#how-to-run)）。
- 所有游戏事件均以英文记录，便于调试和监控。
- **胜利日志**: 全面记录胜利条件、最终Boss击败和通关统计数据。

## 音频资源

游戏使用位于 `assets/` 目录下的以下音效和音乐文件：

1. **音效 (`sounds/`)**:
   - `player_hit.wav` - 玩家被击中音效
   - `player_death.wav` - 玩家死亡音效
   - `enemy_explosion.wav` - 敌人爆炸音效
   - `boss_death.wav` - Boss死亡音效 (也用于胜利音效)
   - `item_pickup.wav` - 道具拾取音效

2. **音乐 (`music/`)**:
   - `background_music.mp3` - 游戏背景音乐

如果这些文件缺失，游戏会优雅地处理，记录一条警告但不会影响游戏运行。

## 开发状态

- ✅ 核心游戏机制已实现
- ✅ 包含最终Boss战的完整胜利系统
- ✅ 具有不同行为的敌人系统
- ✅ 具有独特模式的Boss战
- ✅ 道具掉落和收集系统
- ✅ 增强的音效系统，具有稳定性改进和独立的音频控制
- ✅ 全面的测试覆盖率 (255个测试通过)
- ✅ 优化的视觉反馈系统 (爆炸 vs. 伤害闪现)
- ✅ 多语言支持 (英文、中文)
- ✅ 带通知和胜利界面的动态UI
- ✅ 可配置的游戏参数 (僚机、敌人数量等)
- ✅ 保留背景并带有优雅统计信息的胜利界面

## 技术细节

- 游戏实体设计采用面向对象编程。
- Pygame精灵组 (Sprite Groups) 管理游戏对象和碰撞检测。
- 自定义渲染系统创建游戏视觉效果。
- 集中式的 `FlashEffectManager` 用于处理实体伤害闪现。
- 标准化日志系统追踪游戏事件。
- **增强的音效管理器**: 控制游戏音频播放，具有强大的健康检查、自动恢复系统和独立的音频通道管理。
- **胜利系统架构**:
  - 基于状态的胜利检测，能识别最终Boss
  - 胜利处理的重复防护机制
  - 背景保留渲染系统
  - 半透明浮层合成
  - 全面的统计数据收集和显示
- **🎨 动态背景系统架构**:
  - 双缓冲渲染管道，带惰性初始化
  - 基于目标的元素准备，实现平滑过渡
  - 三次贝塞尔缓动函数，提供专业级动画
  - 使用SDL2混合模式的硬件加速Alpha混合
  - 模块化特效系统，支持Alpha透明度
  - 特定关卡主题管理，带渐进式难度可视化
- **高级Boss系统架构**:
  - 基于状态的攻击模式管理，生命值触发模式转换
  - 动态子弹生成，具有模式特定属性和目标追踪
  - 多层视觉效果系统，预计算闪现序列
  - 基于游戏进度的自适应移动边界
  - 基于遮罩的精确碰撞检测
  - 带模式指示器的实时生命条渲染
- **Boss子弹系统**:
  - 工厂模式用于模式特定的子弹创建
  - 基于攻击模式的动态大小和颜色调整
  - 终极模式子弹的玩家追踪算法。子弹的垂直速度受限，确保玩家仍能躲避。
  - 增强视觉效果的多层发光效果。
- **UI系统增强**:
  - 通知去重系统
  - 保留背景的浮层渲染
  - 多层透明度效果
  - 响应式布局管理
- 模块化架构便于扩展和维护。
- **测试驱动开发**: 拥有255个测试的广泛测试套件，覆盖所有游戏机制、胜利条件、碰撞系统和边界情况。
- 本地化系统支持多语言。 