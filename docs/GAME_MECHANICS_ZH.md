# 游戏机制指南

本文档包含有关《雷霆战机》游戏机制、系统和游戏功能的详细信息。

## 相关文档

- [本地化指南](LOCALIZATION_ZH.md) - 多语言支持和中文字体优化系统的综合指南
- [架构指南](ARCHITECTURE_ZH.md) - 完整的系统架构和技术设计文档
- [开发路线图](DEVELOPMENT_ROADMAP.md) - 计划中的改进和实施任务
- [开发历史](DEVELOPMENT_HISTORY.md) - 项目演进和主要改进时间线

## 内部游戏机制

### 游戏胜利系统
- **胜利条件**: 玩家通过在最高游戏级别（可通过 `MAX_GAME_LEVEL` 常量配置）击败最终 Boss 来取得胜利
- **最终 Boss 战**: 最终 Boss 提供增强的挑战，并有双倍分数奖励（Boss 等级 × 1000 分，而普通为 500 分）
- **胜利处理**:
  - 最终 Boss 被击败时自动检测胜利
  - 游戏状态立即转换到胜利模式
  - 背景音乐淡出，播放胜利音效
  - 阻止后续敌人/物品生成
- **胜利统计**: 全面的完成数据，包括：
  - 包含击败 Boss 奖励的最终得分
  - 总生存时间（分钟）
  - 完成的关卡数
  - 成就通知
- **胜利界面**:
  - 保留游戏背景以实现视觉连续性
  - 带有优雅胜利面板的半透明覆盖层
  - 居中显示的统计数据，采用绿色胜利主题
  - 闪烁的退出提示，供用户交互
- **重复预防**: 强大的系统可防止多次胜利处理和通知泛滥

### 玩家系统
- **僚机**: 玩家可以拥有可配置数量的僚机（默认最大为 2），从游戏第 3 级开始通过 `WingmanItem` 收集。僚机会为玩家吸收一次攻击，并牺牲自己。初始数量、最大数量和编队间距均可在 `constants.py` 中配置。
- **导弹**: 僚机定期发射跟踪导弹。这些导弹会寻找最近的敌人，如果 Boss 存在，则优先攻击 Boss。

### 敌人系统
- **🛸 敌人视觉设计**: 完整的有机/外星生物力学外观系统
  - **尺寸**: 45×45 像素（与玩家的 60×50 不同）
  - **形状**: 不规则的有机外壳，带有外星附属物，而非几何机翼
  - **外星特征**: 生物传感器（“眼睛”）取代驾驶舱，有机排气口取代引擎
  - **面向前方**: 所有敌人都正确朝向，生物推进器指向玩家
- **按等级划分的敌人主题**: 跨难度等级的渐进式外星进化
  - **1-3 级 (昆虫形态)**: 深红色/红色的生物，具有侵略性的有机外观
  - **4-6 级 (剧毒外星生物)**: 有毒的绿色实体，具有生物发光效果
  - **7-9 级 (能量生物)**: 紫色虚空生物，具有能量表现形式
  - **10+ 级 (噩梦虚空)**: 暗能量生物，具有明亮的强调色和最大的生物发光
- **敌人等级**: 敌人等级范围为 0-10。等级越高，生命值、速度和攻击力越强。
- **敌人生成**: 随着游戏进行和游戏等级提升，敌人的数量和等级会增加。
- **敌人射击**: 2 级及以上的敌人可以射击（可通过 `ENEMY_SHOOT_LEVEL` 常量配置）。射速和子弹速度随等级增加。
  - 低级敌人：发射简单的直线下降子弹。
  - 中级敌人：发射更快的子弹，可能有更复杂的模式。
  - 高级敌人：发射更快、伤害更高的子弹。

### 子弹系统
- **玩家子弹**: 根据收集的物品，最多可有 4 条射击路径。
- **敌人子弹**: 根据敌人等级，外观、速度和伤害不同。
- **Boss 子弹**: 特殊的大型子弹，伤害更高。

### 物品系统
- **生命物品**: 恢复玩家生命值。
- **子弹速度物品**: 增加玩家子弹速度。
- **子弹路径物品**: 增加玩家射击路径数量。
- **玩家速度物品**: 增加玩家移动速度。
- **僚机物品**: 增加一架僚机与玩家并肩作战。
- **物品生成**: 随着游戏进行和击败敌人获得分数，物品会随机生成。

### Boss 系统
- **Boss 等级**: Boss 根据游戏进度动态生成。其等级计算公式为 `max(1, (game_level + 1) // 2)`。这意味着随着玩家在游戏的 10 个关卡中前进，Boss 等级会提升。
- **Boss 生成**: 从游戏第 2 级开始，每 30 秒生成一个 Boss。在早期关卡（0-1）中不会出现 Boss。
- **Boss 生命系统**:
  - 基础生命值: `100 + (level-1) * 50` 点
  - Boss 上方显示带有等级指示器的生命条
  - 生命条颜色根据攻击模式变化
- **Boss 攻击模式**: Boss 有三种不同的攻击模式，根据生命值百分比变化：
  - **普通模式** (100%-50% 生命值): 标准子弹模式
    - 1 级: 3 颗子弹呈直线排列
    - 2 级: 4 颗子弹呈扇形模式
    - 3+ 级: 5 颗子弹呈更宽的扇形模式
  - **侵略模式** (50%-25% 生命值, 仅限 2 级以上): 子弹数量增加，射速更快
    - 射击延迟减少 30%
    - 更多子弹，散布范围更广
    - 生命条显示黄色边框警告
  - **最终模式** (25%-0% 生命值, 仅限 3 级以上): 强度最大，并跟踪玩家
    - 射击延迟额外减少 20%
    - 最大子弹数量（3+ 级最多 7 颗）
    - 部分子弹跟踪玩家位置
    - 生命条显示闪烁的红色边框
- **Boss 移动**:
  - 入场动画: 从屏幕顶部滑下
  - 水平移动: 左右移动模式，边界动态变化
  - 移动速度随游戏等级增加
  - 移动范围随游戏进度调整
- **Boss 子弹**: 具有基于模式特性的特殊子弹系统：
  - **普通子弹**: 洋红色，标准速度（5 像素/帧），10 点伤害
  - **侵略子弹**: 橙红色，速度更快（6 像素/帧），15 点伤害，尺寸大 20%
  - **最终子弹**: 青色，速度最快（7 像素/帧），20 点伤害，尺寸大 30%，跟踪玩家
- **视觉效果**:
  - 多层伤害闪烁效果（白、红、黄）
  - 生命条上的攻击模式指示器
  - 多层发光子弹效果
- **击败 Boss 奖励**: 击败 Boss 可获得分数奖励（普通 Boss 为 Boss 等级 × 500 分，最终 Boss 为 Boss 等级 × 1000 分），并立即触发关卡晋级或游戏胜利。

### 关卡进度系统
- **游戏早期 (0-1 级)**: 玩家通过累积得分晋级。这提供了一个友好的学习阶段，玩家可以在没有 Boss 压力的情况下熟悉游戏机制。
- **游戏中后期 (2+ 级)**: 关卡进度完全通过击败 Boss 实现。累积得分不再触发关卡提升，从而创建了一个基于技能的进度系统。
- **最终关卡胜利**: 到达并击败 `MAX_GAME_LEVEL` 的 Boss 会触发游戏完成，而非进一步的进度。
- **双重进度机制**:
  - 基于分数的进度: 仅适用于 0→1 和 1→2 级
  - 基于击败 Boss 的进度: 从 2 级开始可用，提供更大的奖励和挑战
  - 胜利完成: 在最高等级击败最终 Boss 触发游戏完成
- **清晰的进度路径**: 玩家在升级时会收到清晰的视觉通知，包括已清除的敌人数量和获得的奖励分数。

### 视觉效果系统
- **🎨 动态关卡背景系统**: 革命性的双缓冲渲染，实现无缝关卡过渡
  - **关卡主题**: 每个关卡都有独特的视觉标识，反映难度进展：
    - 1 级“深空”: 宁静的蓝/黑色星空（2 个星云，1 颗行星）
    - 2 级“星云区”: 紫/蓝色云彩（4 个星云，2 颗行星）
    - 3 级“小行星带”: 棕/橙色小行星带，带有动态碎片（3 个星云，3 颗行星）
    - 4 级“红色区域”: 危险的红色太空，带有粒子风暴效果（5 个星云，2 颗行星）
    - 5+ 级“最终之战”: 不祥的暗红色氛围，伴有强烈的风暴（6 个星云，1 颗行星）
  - **双缓冲技术**: 将关卡背景预渲染到单独的缓冲区，以实现无瑕疵的过渡
  - **平滑过渡**: 使用三次贝塞尔缓动 (t³(6t² - 15t + 10)) 和 alpha 混合，实现 3 秒过渡
  - **特效**:
    - 太空风暴: 动态的红色粒子，具有正弦运动，用于危险关卡
    - 小行星带: 程序化生成的旋转小行星，用于第 3 级
    - Alpha 支持: 所有效果在过渡期间都支持平滑的淡入/淡出
  - **硬件优化**: 使用 pygame.BLEND_ALPHA_SDL2 以获得最佳性能
  - **视觉润色**: 增强的关卡指示器，带有发光效果和微妙的覆盖层
- **爆炸**: 当实体（敌人、僚机）被摧毁或导弹击中目标时发生。
- **闪光效果**: 用于非致命伤害。实体本身会闪烁特定颜色以表示被击中。这提供了更清晰的反馈，而不会使屏幕混乱。
    - 玩家被击中: 闪烁白色。
    - Boss 被子弹击中: 闪烁黄色。
    - Boss 被导弹击中: 闪烁红色（除了导弹的爆炸）。
- **胜利效果**: 游戏完成时的特殊视觉处理：
    - 保留背景以实现视觉连续性
    - 半透明覆盖系统
    - 带有边框效果的优雅胜利面板
    - 从游戏状态平滑过渡到胜利状态

### 声音系统
- **背景音乐**: 在游戏过程中循环播放，胜利时自动淡出。
- **爆炸声**: 敌人被摧毁时播放。
- **命中声**: 玩家受到伤害时播放。
- **死亡声**: 玩家飞船被摧毁时播放。
- **拾取物品声**: 收集物品时播放。
- **击败 Boss 声**: 成功击败 Boss 时播放。
- **胜利声**: 游戏完成时的特殊音频反馈。
- **音量控制**: 音效和音乐音量可以独立调节。
- **系统稳定性**: 声音系统包括一个强大的健康检查和自动恢复机制。它会定期检查其状态，并在检测到问题时自动重新初始化（例如，如果背景音乐意外停止）。这确保了长时间游戏过程中的高可靠性。
- **音频独立性**: 修复了切换音效会错误地停止背景音乐的问题。音乐和音效现在按预期独立运行。

### 日志系统
- 标准化日志输出，支持不同级别（DEBUG、INFO、WARNING、ERROR、CRITICAL）。
- 可以通过 `THUNDER_FIGHTER_LOG_LEVEL` 环境变量调整日志级别（请参阅 `README.md` 中的[如何运行](#how-to-run)）。
- 所有游戏事件都以英文记录，便于调试和监控。
- **胜利日志**: 全面记录胜利条件、最终 Boss 击败和完成统计数据。

## 声音资源

游戏使用位于 `assets/` 目录下的以下声音和音乐文件：

1. **声音 (`sounds/`)**:
   - `player_hit.wav` - 玩家命中声
   - `player_death.wav` - 玩家死亡声
   - `enemy_explosion.wav` - 敌人爆炸声
   - `boss_death.wav` - Boss 死亡声（也用于胜利）
   - `item_pickup.wav` - 拾取物品声

2. **音乐 (`music/`)**:
   - `background_music.mp3` - 游戏背景音乐

如果这些文件丢失，游戏将优雅地处理丢失的声音，记录警告但不会影响游戏玩法。

## 实现状态

### ✅ 已完成功能
- **核心玩法**: 玩家移动、射击、碰撞检测
- **胜利系统**: 最终 Boss 战和游戏完成
- **敌人系统**: 多级敌人，难度递增
- **Boss 战**: 三种攻击模式，基于生命值转换
- **物品系统**: 五种类型的强化道具，效果可配置
- **声音系统**: 背景音乐、音效和音量控制
- **视觉效果**: 爆炸、伤害闪烁和动态背景
- **多语言支持**: 中英文动态切换
- **僚机系统**: 带有跟踪导弹的伴侣战斗机
- **关卡进度**: 基于分数和击败 Boss 的进度机制

### 🔧 系统可靠性
- **暂停系统**: 暂停感知的计时计算
- **输入处理**: 跨平台输入，带回退机制
- **字体渲染**: 优化的 macOS 中文字体支持
- **测试覆盖**: 375+ 项全面测试，覆盖所有系统

## 相关文档

- **[架构指南](ARCHITECTURE_ZH.md)** - 系统架构和设计模式
- **[技术细节](TECHNICAL_DETAILS_ZH.md)** - 技术实现和优化
- **[开发路线图](DEVELOPMENT_ROADMAP.md)** - 开发路线图和计划功能
- **[本地化指南](LOCALIZATION_ZH.md)** - 多语言支持指南
- **[开发历史](DEVELOPMENT_HISTORY.md)** - 项目演进时间线

---

*有关技术实现细节、平台特定优化和架构改进，请参阅[技术细节](TECHNICAL_DETAILS_ZH.md)。*
