# Thunder Fighter 伪3D改造方案评审（Review）

本评审文档基于现有方案与实现规划，聚焦“是否采纳、如何采纳、采纳边界”。面向讨论与决策使用。

- 相关文档：
  - 提案：`docs/PSEUDO_3D_PROPOSAL.md`
  - 设计：`docs/PSEUDO_3D_IMPLEMENTATION_DESIGN.md`
  - 代码变更规划：`docs/PSEUDO_3D_CODE_CHANGES.md`

## 一、结论摘要（建议采纳的组合方案）

- 采纳建议：采纳“方案一 深度缩放系统”为核心，并在背景层增加“扫描线式透视背景（Mode 7 子集，仅限背景）”的可选增强，形成“核心深度缩放 + 背景透视增强”的组合方案。
- 关键理由：
  - 与题材/玩法匹配度高：太空纵版射击没有地面赛道，完整 Mode 7 的收益主要在背景视觉而非交互；
  - 改造成本可控：在当前事件驱动 + 系统分层架构中，仅增量引入 `z`、深度排序与受控缩放/雾化即可，低耦合、易回滚；
  - 性能路径明确：缩放量化 + LRU 缓存、LOD 与节流、背景扫描线仅在局部行段生效，整体可在现有帧预算内迭代打磨。

## 二、选型对比与取舍

- 深度缩放系统（推荐核心）
  - 优点：实现简、风险小、可逐步推广到敌机/粒子/UI；
  - 风险：大规模实时平滑缩放开销；
  - 缓解：缩放桶量化 + LRU 贴图缓存；近处使用 `scale/scale_by`，仅在预热/资源阶段用 `smoothscale/rotozoom`；
- Mode 7（完整）
  - 优点：道路/地平线效果强；
  - 风险：实现复杂且与玩法不完全契合，易侵入碰撞/弹幕表现；
  - 决策：不作为主体，仅在背景局部采用扫描线式透视重采样；
- 分层 2.5D
  - 优点：可控、性能可预测；
  - 缺点：深度过渡不够平滑、灵活性不足；
  - 决策：作为工程手段辅助（例如背景/装饰物的固定层管理），不单独作为主方案；
- 其他（Raycast、OpenGL/ModernGL 迁移）
  - 与玩法/资产/打包成本不匹配；短期不建议。

参考与外部验证：
- pygame.transform 文档：实时缩放优先 `scale/scale_by`，平滑缩放成本更高，适合离线/预计算（Pygame 官方文档）。
- GameDev.SE 讨论：在纯 Pygame 中完整 Mode 7 实现复杂，性价比不高，通常以简化/局部背景效果替代。
- Lou’s Pseudo‑3D：扫描线透视对地平线/背景沉浸感提升明显，适合限定在背景层使用。

## 三、范围、边界与非目标

- 目标内：
  - 为实体引入 `z` 与投影视图位置、深度排序；
  - 可见性/雾化/去饱和等深度相关视觉；
  - 背景层的扫描线式透视（可配置开关，仅背景);
  - 粒子与 UI 的轻度 3D 化（可选、演出向）。
- 非目标（本阶段不做）：
  - 完整 Mode 7 的全屏仿射/地形系统；
  - 碰撞 3D 化（保持现有 2D 命中箱，必要时限定视觉与碰撞箱的比例上限）。

## 四、性能预算与成功指标

- 帧率目标：1080p 开发环境 ≥ 120 FPS；最低配置（目标机型）≥ 60 FPS。
- CPU 预算（渲染阶段）：
  - 缩放缓存命中率 ≥ 85%；
  - 每帧新缩放生成次数 ≤ 5（峰值 ≤ 10）；
  - 背景扫描线透视耗时 ≤ 1.0 ms（1080p），可通过低分辨率中间缓冲放大实现；
- 内存：贴图缩放缓存上限（可配置，例如 64–128 个桶、LRU 淘汰），开发模式展示实时占用；
- 质量：
  - 远景实体的雾化与亮度压制平滑、无明显跳变；
  - 小尺寸裁剪阈值生效（可见宽/高 < 2px 不渲染）。

## 五、风险清单与对策

- 性能抖动（大量实体同时进入可见区）：
  - 对策：贴图预热、缩放桶量化、LRU 缓存、逐帧限额（超额延后生成）。
- 难度/判定变化（视觉缩放影响体感）：
  - 对策：碰撞仍按逻辑尺寸，限制视觉与碰撞箱的最大偏差比例；新增“命中辅助”仅在远景深度触发（可选）。
- 代码复杂度增长：
  - 对策：3D 基类 + 深度渲染组隔离；引入开关与降级路径，保留 2D 回退渲染流程。

## 六、开发与验证计划（迭代/回滚友好）

- M1（核心打底，1–2 天）
  - 实体 `z`、深度排序渲染组、缩放桶量化 + LRU；
  - 开发模式性能面板：帧耗、缓存命中率、缓存大小；
  - 验证：样例敌机进近/远离、粒子雾化。
- M2（整合与优化，2–3 天）
  - 扫描线式背景透视原型（仅开发配置），与多层视差并存；
  - LOD 与更新节流策略落地；
  - 验证：压力场景（高刷 + 大量实体 + 背景透视）。
- M3（可选演出，2–3 天）
  - 粒子/UI 渐进 3D 化、Boss 入场演出；
  - 调参与视觉打磨，补充基准录屏。

回滚点：
- 背景透视为完全可选模块；
- 3D 渲染路径通过特性开关可整体禁用，回退至原 2D 管线。

## 七、测试与质量保障

- 单元：
  - 缩放桶量化函数、缓存键策略、LRU 淘汰；
  - LOD 策略的阈值与分支覆盖；
- 集成/系统：
  - 帧内新缩放生成次数与命中率统计；
  - 开关/降级路径（启用/禁用 3D、背景透视）；
- 准入门槛：
  - 指标达标（见第四节）；
  - 关键路径无回归（现有测试通过 + 新增用例通过）。

## 八、对产品与工具链的影响

- 资产：现有程序化 Surface 可复用；如后续引入位图资源，建议提供多分辨率源图以利于缓存命中。
- 打包/依赖：维持纯 Pygame，不新增外部图形依赖；无需调整打包。
- 文档：新增开发模式性能面板使用说明；关卡设计指南补充“深度相关演出”的约束与建议。

## 九、待决问题（供评审会讨论）

1) 是否需要在低端设备上强制关闭背景透视以保障 60 FPS？
2) 远景命中辅助是否纳入本阶段，还是留给平衡迭代？
3) LRU 缓存上限与缩放桶密度的默认配置（质量 vs 内存/性能）？
4) UI 3D 化范围（仅分数漂浮，还是包含 Boss 预警/提示动画）？

## 十、采纳建议（决策格式）

- 选项 A（推荐）：采纳“核心深度缩放 + 背景透视增强”的组合方案；按 M1→M2→M3 推进，M2 的背景透视为可选开关。
- 选项 B：仅采纳“核心深度缩放”，不做背景透视；
- 选项 C：保持 2D，不采纳伪 3D（保留文档与原型）。

若选 A/B，需确认第四、六节中的准入指标与回滚点作为验收标准。

——
文档日期：2025-09-19
作者：项目助理（Review）
